---
name: kubemin-agent-code
description: 帮助用户更规范地开发 KubeMin-Agent 项目（Python Agent）
metadata:
  short-description: 支持 KubeMin-Agent 的开发
---

## 范围

本技能定义了协助 **KubeMin-Agent** 项目（Python AI Agent）开发的工作协议，包括沟通规范、代码变更流程、测试约定、命名规范、文档同步和 PR 规范。

---

## 规则优先级

当规则冲突时，按如下优先顺序执行：
1. **安全** > 正确性 > 性能
2. **用户显式指令** > SKILL 规则 > 通用最佳实践
3. **单轮交付**（低风险） > 多轮确认
4. **现有项目约定** > 通用 Python 约定

---

## 1. 风险评估与交付策略

### 风险等级

| 等级 | 判定标准 | 交付策略 |
|------|----------|----------|
| **LR0** (纯内部) | 无公开 API/行为变更，不涉及持久化/并发/安全，单模块范围，行为保留的重构或非功能性变更 | 单轮交付 |
| **LR1** (有限域) | 涉及持久化/并发/安全但满足下方全部 LR1 约束 | 单轮交付（含验证） |
| **中/高** | API/行为变更、Schema 变更、新增共享并发状态、安全边界扩展、跨模块影响 | 先确认方案 |

### LR1 约束（须全部满足）

- **范围限制**: ≤3 文件 或 ≤200 LOC 变更
- **局部修复/安全修复**，无 API/契约变更
- **可测试或可验证**，步骤可复现
- **无 Schema 变更**（数据迁移、序列化格式）
- **无新增共享并发状态**（如新全局字典 + 锁）
- **无权限/访问范围扩展**

> **LR1 排除项**: Schema 变更、跨模块协议/序列化格式变更、新增共享并发状态、放宽认证/访问范围。

### 效率规则

- **低风险但模糊**: 带明确假设推进。仅在假设可能影响正确性、安全性或公开行为时才提问。
- **单轮优先**: 在一次回复中交付方案 + 代码 + 测试/验证 + 文档/PR，除非中/高风险需确认。
- **批量处理**: 同一会话中多项低风险变更 → 一次合并交付。

### 交付块顺序

```
1. 风险评估 (LR0/LR1/中/高)
2. 假设（如有歧义）
3. 方案（将变更什么）
4. 补丁（代码变更）
5. 测试/验证（如有意义）
6. 文档/PR（仅在需要时）
```

---

## 2. 沟通

- 默认使用 **中文** 与用户沟通
- 文档默认中文；仅在用户明确要求时使用英文
- 仅在用户要求时为特定产物提供英文版

---

## 3. 代码规范

### 命名
- 遵循 Python PEP 8 规范：`snake_case` 用于函数/变量/模块，`CamelCase` 用于类名
- 优先沿用项目中已有的命名模式
- 名称应清晰表达意图；避免缩写（项目内标准缩写除外）

### 风格
- 追求简洁；避免过度工程
- 函数短小、可组合、Early Return
- 异步代码使用 `async/await`，正确传播取消与超时
- 错误使用自定义异常，包含可追溯的上下文信息
- 类型标注：所有公共接口添加完整 Type Hints

### 常量与配置

| 类型 | 位置 |
|------|------|
| 单包常量 | 最近的包内（如 `agent/constants.py`） |
| 跨域常量 | `config/constants.py` 或项目既有公共常量位置（避免反向依赖业务包） |
| 运行时可配置值 | `config/` 包，使用 Pydantic Settings |

> **规则**: 可复用字符串/枚举应集中管理，避免散落硬编码。仅运行时可配置的项属于 `config/`。

### 项目架构约定

| 模块 | 职责 |
|------|------|
| `agent/` | 核心 Agent 逻辑（Loop、Context、Memory、Skills） |
| `agent/tools/` | 工具注册与执行（Base、Registry、具体工具实现） |
| `providers/` | LLM Provider 抽象与具体实现 |
| `bus/` | 消息总线（解耦 Channel 与 Agent） |
| `channels/` | 通道接入（CLI、Telegram 等） |
| `session/` | 会话管理与持久化 |
| `config/` | 配置模型与加载 |
| `cron/` | 定时任务调度 |
| `heartbeat/` | 心跳检测与主动唤醒 |
| `skills/` | 内置技能 |
| `cli/` | CLI 命令入口 |
| `utils/` | 通用工具函数 |

### 自查
实现后：消除重复、减少嵌套、移除冗余分支、检查类型标注完整性。

---

## 4. 测试要求

| 变更类型 | 测试策略 |
|----------|----------|
| LR0 (非功能性) | 仅在有意义时加测试 |
| LR0 (逻辑变更) | 覆盖修改逻辑的最小单测 |
| LR1 变更 | 单测 或 验证步骤 |
| 中/高风险 | 完整覆盖：参数化测试、边界用例、失败路径 |

### 测试豁免与替代

当单测不可行时，记录：
1. **为何不可测**: 如 Handler 层依赖复杂外部组件
2. **替代验证**（必须**可复现且可直接执行**）：
   - 精确的执行命令
   - 预期输出/行为

**Handler 层豁免**: 若 Handler 层无单测，必须提供：
- 底层 Service/Domain 层的单测覆盖（如受当前变更影响），或
- 可复现的 curl/CLI/集成命令与预期结果

豁免场景：
- 日志/注释/格式变更（测试无意义）
- Handler 代码有复杂依赖（但 Service 层必须覆盖）

### 测试组织
- 使用 `pytest` 作为测试框架
- 同一功能的测试放在**同一测试文件中**
- 扩展已有 `test_*.py` 文件；只在无合适文件时新建
- 使用 `conftest.py` 管理共享 fixture

---

## 5. 文档更新

### 触发条件

| 变更影响 | 需要更新 `docs/`? |
|----------|-------------------|
| 用户可见行为/API/配置/运维 | ✅ 是 |
| 契约日志 | ✅ 是 |
| 调试/诊断日志 | ❌ 否 |
| 错误契约变更 | ✅ 是 |
| 默认值/语义变更 | ✅ 是 |
| 纯内部重构/非功能性 | ❌ 否 |

### 文档内容（需要时）
- 摘要、动机、关键设计决策
- API/行为变更
- 测试覆盖描述
- 测试执行命令

### 组织规则
- 同一 PR 的文档合并为**每个主题一个 Markdown 文件**
- 如仓库缺少 `docs/` 目录 → 先确认再创建；否则更新已有结构
- 语言：默认中文

---

## 6. PR 指南

### 格式
- **标题**: 清晰的祈使句
- **正文**: 摘要 / 变更 / 测试 / 备注
- ⚠️ 使用真换行，而非 `\n` 转义符

### 何时提供 PR 描述
- 用户明确要求（"给我 PR 描述" / "准备提交 PR"）
- 变更需要文档/示例（完整交付场景）
- 默认：仅提供标题 + 简要摘要

### 更新
仅在新提交改变范围或实质影响用户可见行为/API、配置或风险时才更新 PR 描述。

---

## 7. 依赖管理

### 核心依赖约定

| 用途 | 推荐库 |
|------|--------|
| CLI 框架 | `typer` |
| LLM 网关 | `litellm` |
| 配置模型 | `pydantic` + `pydantic-settings` |
| HTTP 客户端 | `httpx` |
| 日志 | `loguru` |
| 定时调度 | `croniter` |
| 终端输出 | `rich` |
| 异步 WebSocket | `websockets` |

### 规则
- 新增依赖须说明理由，优先复用已有依赖
- 使用 `pyproject.toml` 管理依赖
- 使用 `hatchling` 作为构建后端

---

## 8. 反模式

| ❌ 不要 | ✅ 应该 |
|---------|---------|
| 滥用 LR1 做 Schema/共享状态变更 | 仅在定义约束内使用 LR1 |
| 跳过测试且无可复现替代方案 | 提供可直接执行的验证命令 |
| 为每条日志变更写文档 | 仅为契约日志写文档 |
| 跨域常量放在随机包内 | 使用 `config/constants.py` 管理共享常量 |
| 总是生成完整文档/PR | 仅在需要时才生成 |
| 绕过 AgentLoop 直接修改流程 | 新增能力必须挂在既有接口下 |
| 在工具返回中暴露敏感信息 | API Key 仅从配置或环境变量读取 |

---

## 9. 交付前检查清单

- [ ] 风险等级 (LR0/LR1/中/高) 正确评估？
- [ ] LR1 约束已验证（≤3 文件，无 Schema/共享状态变更）？
- [ ] 交付块顺序已遵循？
- [ ] 测试已提供 或 可复现验证已记录？
- [ ] 契约日志在要求文档前已声明？
- [ ] 文档/PR 仅在需要时才提供？
- [ ] 类型标注完整？
- [ ] async/await 使用正确？

---

## 决策流程

```
接收请求 → 评估风险
    │
    ├── LR0 (纯内部)
    │     └── 单轮：方案 + 补丁 + 测试（如有意义）+ 文档（如需要）
    │
    ├── LR1 (有限域) — 先验证约束
    │     ├── ≤3 文件, ≤200 LOC?
    │     ├── 无 Schema/共享状态/权限扩展?
    │     └── 是 → 单轮：方案 + 补丁 + 测试/验证 + 文档（如需要）
    │
    └── 中/高
          └── 先确认方案 → 用户批准 → 实现
                  │
                  ├── 影响公开 API? → 生成 examples/
                  │     (含默认值、分页)
                  │
                  └── 用户可见变更? → 生成 docs/
                        (仅契约日志)
```
